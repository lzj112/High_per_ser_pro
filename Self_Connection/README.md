# 自连接

客户端一般不 bind, 这时候由内核随机分配一个 port, 但是如果这个时候正好分配的那个 port 就是你想 connect 的 port, 就会发生自连接, 而且认为连接成功, 而且服务器不能启动, 在上面的示例中验证了, 如果服务器启动状况下, 就算客户端 bind 服务器的 port, 然后再 connect 这个 port, 会连接上服务器, 不会发生自连接

所以, 自连接的条件是:
**1. 客户端和服务端进程在同一个主机
2. 源端口号和目的端口号相同
3. 只启动了客户端**

# 判断自连接

## 很简单的两个示例:

- server.c

使用阻塞套接字 accept,有新的连接接收并打印返回的套接字

- client.c

使用阻塞套接字 connect, 在成功后再次调用 connect 进行判断, 如果连接成功无误, 会返回 EISCONN

因为自连接不被认为是 TCP 协议实现中的 bug, 所以不管是正常连接还是自连接, 再次调用 connect 都会返回 EISCONN, 我们再输出服务端和客户端的 IP port 进行比对

# 如何预防自连接

客户端默认分配的端口号在 `/proc/sys/net/ipv4/ip_local_port_range`, 只需要让服务器避开, 比如这个范围默认最小是从`32768`开始, 让服务器 bind 一个低于`32768`的 port
